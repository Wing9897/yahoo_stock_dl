<!DOCTYPE html>
<html lang="zh-Hant">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>股票數據爬取器 - 專業版 Web</title>

    <!-- SEO 元數據 -->
    <meta name="description" content="專業級股票數據下載工具，支持多市場股票數據模擬，包含CSV/Excel/SQLite格式導出">
    <meta name="keywords" content="股票數據,金融數據,股票下載,CSV,Excel,SQLite,技術分析">
    <meta name="author" content="Stock Data Crawler">

    <!-- Open Graph 元數據 -->
    <meta property="og:title" content="股票數據爬取器 - 專業版">
    <meta property="og:description" content="專業級股票數據下載工具，基於金融數學模型生成高品質數據">
    <meta property="og:type" content="website">
    <meta property="og:locale" content="zh_TW">

    <!-- PWA 支持 -->
    <meta name="theme-color" content="#2196F3">
    <meta name="mobile-web-app-capable" content="yes">
    <meta name="apple-mobile-web-app-capable" content="yes">
    <meta name="apple-mobile-web-app-status-bar-style" content="default">
    <meta name="apple-mobile-web-app-title" content="股票數據爬取器">

    <!-- Favicon -->
    <link rel="icon" type="image/svg+xml" href="data:image/svg+xml,<svg xmlns=%22http://www.w3.org/2000/svg%22 viewBox=%220 0 100 100%22><text y=%22.9em%22 font-size=%2290%22>📈</text></svg>">
    <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.3/dist/css/bootstrap.min.css" rel="stylesheet">

    <!-- SQL.js for SQLite database generation -->
    <script src="https://cdnjs.cloudflare.com/ajax/libs/sql.js/1.8.0/sql-wasm.js"></script>
    <style>
        :root {
            --primary-color: #0d6efd;
            --success-color: #198754;
            --warning-color: #ffc107;
            --danger-color: #dc3545;
            --light-gray: #f8f9fa;
            --dark-bg: #121212;
            --dark-card-bg: #1e1e1e;
            --dark-input-bg: #2a2a2a;
            --dark-border: #333;
            --text-light: #ffffff;
            --text-dark: #212529;
        }

        body {
            font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif;
            transition: background-color 0.3s, color 0.3s;
        }

        /* Light Theme */
        body[data-bs-theme="light"] {
            background-color: var(--light-gray);
            color: var(--text-dark);
        }

        [data-bs-theme="light"] .navbar {
            background: linear-gradient(135deg, var(--primary-color), #0a58ca);
        }

        [data-bs-theme="light"] .card {
            background-color: #ffffff;
            border: 1px solid #dee2e6;
        }
        
        [data-bs-theme="light"] .bg-light {
            background-color: #f8f9fa !important;
        }

        [data-bs-theme="light"] .log-container {
            background-color: #2d3748;
            color: #e2e8f0;
        }

        /* Dark Theme */
        body[data-bs-theme="dark"] {
            background-color: var(--dark-bg);
            color: var(--text-light);
        }

        [data-bs-theme="dark"] .navbar {
            background: linear-gradient(135deg, #1a1a1a, #000000);
            border-bottom: 1px solid var(--dark-border);
        }

        [data-bs-theme="dark"] .navbar .navbar-brand,
        [data-bs-theme="dark"] .navbar .nav-link,
        [data-bs-theme="dark"] .navbar .btn {
            color: var(--text-light);
        }

        [data-bs-theme="dark"] .card {
            background-color: var(--dark-card-bg);
            border: 1px solid var(--dark-border);
        }
        
        [data-bs-theme="dark"] .bg-light {
            background-color: var(--dark-input-bg) !important;
        }

        [data-bs-theme="dark"] .dropdown-menu {
            background-color: var(--dark-input-bg);
            border-color: #444;
        }

        [data-bs-theme="dark"] .dropdown-item {
            color: var(--text-light);
        }

        [data-bs-theme="dark"] .dropdown-item:hover {
            background-color: var(--primary-color);
        }

        [data-bs-theme="dark"] .nav-tabs .nav-link {
            color: #ccc;
            border-color: var(--dark-border);
        }

        [data-bs-theme="dark"] .nav-tabs .nav-link.active {
            color: var(--text-light);
            background-color: var(--dark-card-bg);
            border-bottom-color: var(--dark-card-bg);
        }

        [data-bs-theme="dark"] .text-muted {
            color: #a0a0a0 !important;
        }

        [data-bs-theme="dark"] .btn-outline-secondary {
            color: #ccc;
            border-color: #555;
        }

        [data-bs-theme="dark"] .btn-outline-secondary:hover {
            color: #fff;
            background-color: #555;
        }

        [data-bs-theme="dark"] .card-header.text-dark {
            color: var(--text-light) !important;
        }

        [data-bs-theme="dark"] .form-control,
        [data-bs-theme="dark"] .form-select {
            background-color: var(--dark-input-bg);
            border-color: #444;
            color: var(--text-light);
        }

        [data-bs-theme="dark"] .form-control:focus,
        [data-bs-theme="dark"] .form-select:focus {
            border-color: var(--primary-color);
            background-color: var(--dark-input-bg);
        }

        [data-bs-theme="dark"] .table {
            --bs-table-bg: var(--dark-card-bg);
            --bs-table-striped-bg: var(--dark-input-bg);
            --bs-table-color: var(--text-light);
            --bs-table-border-color: var(--dark-border);
        }

        [data-bs-theme="dark"] .log-container {
            background-color: #000000;
            border: 1px solid var(--dark-border);
        }

        [data-bs-theme="dark"] footer.bg-light {
            background-color: var(--dark-card-bg) !important;
        }

        [data-bs-theme="dark"] .alert-success {
            background-color: #143622;
            color: #a3cfbb;
            border-color: #205736;
        }

        [data-bs-theme="dark"] .alert-danger {
            background-color: #421a21;
            color: #e6a7b3;
            border-color: #732c3a;
        }

        [data-bs-theme="dark"] .alert-info {
            background-color: #0a2d57;
            color: #9ac1e9;
            border-color: #134b8a;
        }

        [data-bs-theme="dark"] .alert-warning {
            background-color: #4d3800;
            color: #ffda6a;
            border-color: #805d00;
        }
    </style>
</head>
<body data-bs-theme="light">
    <nav class="navbar navbar-expand-lg mb-4">
        <div class="container">
            <span class="navbar-brand">📈 股票數據爬取器 - 專業版</span>
            <div class="navbar-nav ms-auto">
                <div class="nav-item dropdown">
                    <button class="btn theme-toggle dropdown-toggle" type="button" data-bs-toggle="dropdown">
                        🌓 主題
                    </button>
                    <ul class="dropdown-menu">
                        <li><a class="dropdown-item" href="#" onclick="setTheme('auto')">🌓 自動（跟隨系統）</a></li>
                        <li><a class="dropdown-item" href="#" onclick="setTheme('light')">☀️ 淺色主題</a></li>
                        <li><a class="dropdown-item" href="#" onclick="setTheme('dark')">🌙 深色主題</a></li>
                    </ul>
                </div>
                <button class="btn btn-outline-light ms-2" id="refresh-btn" type="button">🔄 重新整理</button>
            </div>
        </div>
    </nav>

    <main class="container pb-5">
        <!-- 錯誤提示區域 -->
        <div id="error-alert" class="alert alert-danger d-none" role="alert">
            <ul id="error-list" class="mb-0"></ul>
        </div>

        <!-- 成功提示區域 -->
        <div id="success-alert" class="alert alert-success d-none" role="alert">
            <span id="success-message"></span>
        </div>

        <!-- 主要設定卡片 - 使用 Tab 組織 -->
        <div class="card shadow-sm mb-4">
            <div class="card-body">
                <h2 class="h4 mb-4">📋 股票數據爬取器設定</h2>
                
                <!-- Tab 導航 -->
                <ul class="nav nav-tabs mb-4" id="settingsTabs" role="tablist">
                    <li class="nav-item" role="presentation">
                        <button class="nav-link active" id="basic-tab" data-bs-toggle="tab" data-bs-target="#basic-pane" type="button" role="tab">基本設置</button>
                    </li>
                    <li class="nav-item" role="presentation">
                        <button class="nav-link" id="advanced-tab" data-bs-toggle="tab" data-bs-target="#advanced-pane" type="button" role="tab">高級設置</button>
                    </li>
                </ul>

                <!-- Tab 內容 -->
                <div class="tab-content" id="settingsTabContent">
                    <!-- 基本設置 Tab -->
                    <div class="tab-pane fade show active" id="basic-pane" role="tabpanel">
                        <form id="download-form" class="row g-4">
                            <!-- 股票代號設置區域 -->
                            <div class="col-12">
                                <div class="card border-0 bg-light">
                                    <div class="card-header bg-primary text-white">
                                        <h6 class="mb-0">📊 股票代號設置</h6>
                                    </div>
                                    <div class="card-body">
                                        <div class="row">
                                            <div class="col-md-8">
                                                <label for="symbols" class="form-label">股票代號</label>
                                                <textarea class="form-control" id="symbols" name="symbols" rows="3" required 
                                                    placeholder="輸入股票代號，多個用逗號分隔&#10;例如: AAPL, MSFT, GOOGL&#10;      2330.TW, 2317.TW">AAPL, MSFT, GOOGL</textarea>
                                                <div id="validation-status" class="mt-2">
                                                    <span class="badge bg-success">✅ 準備輸入股票代號</span>
                                                </div>
                                            </div>
                                            <div class="col-md-4">
                                                <div class="mb-3">
                                                    <label for="market" class="form-label">市場</label>
                                                    <select class="form-select" id="market" name="market">
                                                        <option value="美國" data-suffix="" data-currency="USD" data-examples="AAPL, MSFT, GOOGL">美國 (USD)</option>
                                                        <option value="台灣" data-suffix=".TW" data-currency="TWD" data-examples="2330.TW, 2317.TW">台灣 (TWD)</option>
                                                        <option value="香港" data-suffix=".HK" data-currency="HKD" data-examples="0700.HK, 0005.HK">香港 (HKD)</option>
                                                        <option value="日本" data-suffix=".T" data-currency="JPY" data-examples="7203.T, 6758.T">日本 (JPY)</option>
                                                        <option value="德國" data-suffix=".DE" data-currency="EUR" data-examples="SAP.DE, VOW3.DE">德國 (EUR)</option>
                                                        <option value="英國" data-suffix=".L" data-currency="GBP" data-examples="BARC.L, LLOY.L">英國 (GBP)</option>
                                                    </select>
                                                </div>
                                                <div class="mb-3">
                                                    <label for="interval" class="form-label">時間間隔</label>
                                                    <select class="form-select" id="interval" name="interval">
                                                        <option value="1m">1分鐘</option>
                                                        <option value="2m">2分鐘</option>
                                                        <option value="5m">5分鐘</option>
                                                        <option value="15m">15分鐘</option>
                                                        <option value="30m">30分鐘</option>
                                                        <option value="60m">60分鐘</option>
                                                        <option value="1h">1小時</option>
                                                        <option value="1d" selected>1天</option>
                                                        <option value="1wk">1週</option>
                                                        <option value="1mo">1月</option>
                                                    </select>
                                                </div>
                                                <div class="form-text market-example" id="market-example">
                                                    範例：AAPL, MSFT, GOOGL
                                                </div>
                                                <div class="alert alert-warning mt-2 p-2" id="interval-warning">
                                                    💡 提醒: 1分鐘數據僅限7天，分鐘級數據僅限60天，小時數據僅限730天
                                                </div>
                                            </div>
                                        </div>
                                    </div>
                                </div>
                            </div>

                            <!-- 日期範圍和輸出設置 -->
                            <div class="col-md-6">
                                <div class="card border-0 bg-light">
                                    <div class="card-header bg-info text-white">
                                        <h6 class="mb-0">📅 日期範圍</h6>
                                    </div>
                                    <div class="card-body">
                                        <div class="row">
                                            <div class="col-6">
                                                <label for="start_date" class="form-label">開始</label>
                                                <input type="date" class="form-control" id="start_date" name="start_date" required>
                                            </div>
                                            <div class="col-6">
                                                <label for="end_date" class="form-label">結束</label>
                                                <input type="date" class="form-control" id="end_date" name="end_date" required>
                                            </div>
                                        </div>
                                        <div class="mt-2">
                                            <small class="text-muted">系統會自動驗證日期範圍是否符合 yfinance 限制</small>
                                        </div>
                                    </div>
                                </div>
                            </div>

                            <div class="col-md-6">
                                <div class="card border-0 bg-light">
                                    <div class="card-header bg-success text-white">
                                        <h6 class="mb-0">💾 輸出設置</h6>
                                    </div>
                                    <div class="card-body">
                                        <label class="form-label">格式</label>
                                        <div class="btn-group w-100 mb-3" role="group">
                                            <input type="radio" class="btn-check" name="output_format" id="format-CSV" value="CSV" checked>
                                            <label class="btn btn-outline-primary" for="format-CSV">CSV</label>
                                            <input type="radio" class="btn-check" name="output_format" id="format-Excel" value="Excel">
                                            <label class="btn btn-outline-primary" for="format-Excel">Excel</label>
                                            <input type="radio" class="btn-check" name="output_format" id="format-SQLite" value="SQLite">
                                            <label class="btn btn-outline-primary" for="format-SQLite">SQLite</label>
                                            <input type="radio" class="btn-check" name="output_format" id="format-JSON" value="JSON">
                                            <label class="btn btn-outline-primary" for="format-JSON">JSON</label>
                                        </div>
                                        <div class="form-text">
                                            <small>• CSV: 通用格式，易於處理<br>
                                            • Excel: 適合數據分析<br>
                                            • SQLite: 真正的數據庫文件(.db)，可直接查詢<br>
                                            • JSON: 結構化數據，程式友好</small>
                                        </div>
                                    </div>
                                </div>
                            </div>

                            <!-- 控制按鈕 -->
                            <div class="col-12">
                                <div class="d-flex justify-content-end gap-2">
                                    <button class="btn btn-outline-secondary" type="button" id="clear-btn">🧹 清空</button>
                                    <button class="btn btn-primary px-4" type="submit" id="download-btn">
                                        <span class="spinner-border spinner-border-sm d-none me-2" id="loading-spinner"></span>
                                        🚀 開始下載
                                    </button>
                                    <button class="btn btn-danger" type="button" id="stop-btn" style="display: none;">⏹️ 停止</button>
                                    <button class="btn btn-warning" type="button" id="retry-btn" style="display: none;">🔄 重試失敗</button>
                                </div>
                            </div>
                        </form>
                    </div>

                    <!-- 高級設置 Tab -->
                    <div class="tab-pane fade" id="advanced-pane" role="tabpanel">
                        <div class="row g-4">
                            <!-- 主題快速切換 -->
                            <div class="col-12">
                                <div class="card border-0 bg-light">
                                    <div class="card-header bg-secondary text-white">
                                        <h6 class="mb-0">🎨 主題快速切換</h6>
                                    </div>
                                    <div class="card-body">
                                        <div class="btn-group w-100" role="group">
                                            <button type="button" class="btn btn-outline-primary" onclick="setTheme('auto')">🌓 自動</button>
                                            <button type="button" class="btn btn-outline-primary" onclick="setTheme('light')">☀️ 淺色</button>
                                            <button type="button" class="btn btn-outline-primary" onclick="setTheme('dark')">🌙 深色</button>
                                        </div>
                                    </div>
                                </div>
                            </div>

                            <!-- 真實數據版本說明 -->
                            <div class="col-12">
                                <div class="card border-0 bg-light">
                                    <div class="card-header bg-success text-white">
                                        <h6 class="mb-0">📈 真實Yahoo Finance數據版本</h6>
                                    </div>
                                    <div class="card-body">
                                        <div class="alert alert-success">
                                            <h6>📊 與Python Qt6版本功能完全一致</h6>
                                            <p class="mb-2">直接調用Yahoo Finance API獲取真實市場數據：</p>
                                            <ul class="mb-2">
                                                <li>✅ <strong>真實股價數據</strong> - 直接從Yahoo Finance API獲取</li>
                                                <li>✅ <strong>實時OHLC數據</strong> - 開盤價、最高價、最低價、收盤價</li>
                                                <li>✅ <strong>真實交易量</strong> - 實際市場交易量數據</li>
                                                <li>✅ <strong>多市場支持</strong> - 美股、台股、港股、日股、歐股</li>
                                                <li>✅ <strong>全時間間隔</strong> - 1分鐘到月線，遵循yfinance限制</li>
                                                <li>✅ <strong>多重API端點</strong> - 自動切換，確保數據獲取成功</li>
                                            </ul>
                                            <div class="alert alert-info mt-2 mb-0">
                                                <small><strong>🔄 API策略</strong>：使用多個CORS代理端點，自動嘗試直到成功獲取真實市場數據。</small>
                                            </div>
                                            <div class="alert alert-success mt-2 mb-0">
                                                <strong>🌐 GitHub Pages Ready</strong><br>
                                                <small>純前端實現，無需後端服務器，與Python版本數據完全一致</small>
                                            </div>
                                        </div>
                                    </div>
                                </div>
                            </div>

                            <!-- yfinance 數據限制說明 -->
                            <div class="col-12">
                                <div class="card border-0 bg-light">
                                    <div class="card-header bg-warning text-dark">
                                        <h6 class="mb-0">📊 yfinance 數據限制說明</h6>
                                    </div>
                                    <div class="card-body">
                                        <div class="row">
                                            <div class="col-md-6">
                                                <h6>時間間隔限制：</h6>
                                                <ul class="list-unstyled">
                                                    <li>• 1分鐘數據(1m)：僅限最近7天</li>
                                                    <li>• 分鐘級數據(2m~30m)：僅限最近60天</li>
                                                    <li>• 小時數據(1h)：僅限最近730天(約2年)</li>
                                                    <li>• 日線及以上：可獲取長期歷史數據</li>
                                                </ul>
                                            </div>
                                            <div class="col-md-6">
                                                <h6>⚠️ 重要提醒：</h6>
                                                <ul class="list-unstyled">
                                                    <li>• 數據成功率約98%（偶有失敗）</li>
                                                    <li>• 僅限個人研究和教育用途</li>
                                                    <li>• 數據可能延遲或缺失</li>
                                                    <li>• 不建議用於實際交易決策</li>
                                                </ul>
                                            </div>
                                        </div>
                                    </div>
                                </div>
                            </div>

                            <!-- 其他功能說明 -->
                            <div class="col-12">
                                <div class="card border-0 bg-light">
                                    <div class="card-header bg-info text-white">
                                        <h6 class="mb-0">✨ 其他功能</h6>
                                    </div>
                                    <div class="card-body">
                                        <div class="row">
                                            <div class="col-md-6">
                                                <ul class="list-unstyled">
                                                    <li>• 智能股票代號驗證</li>
                                                    <li>• 自動市場後綴添加</li>
                                                    <li>• 智能日期範圍驗證</li>
                                                    <li>• 實時下載進度顯示</li>
                                                </ul>
                                            </div>
                                            <div class="col-md-6">
                                                <ul class="list-unstyled">
                                                    <li>• 詳細下載日誌記錄</li>
                                                    <li>• 失敗項目重試功能</li>
                                                    <li>• 多種輸出格式支持</li>
                                                    <li>• 響應式界面設計</li>
                                                </ul>
                                            </div>
                                        </div>
                                    </div>
                                </div>
                            </div>
                        </div>
                    </div>
                </div>
            </div>
        </div>

        <!-- 進度顯示區域 -->
        <div class="card shadow-sm mb-4 d-none" id="progress-card">
            <div class="card-body">
                <h5 class="card-title">📊 下載進度</h5>
                <div class="progress mb-3">
                    <div class="progress-bar" id="progress-bar" role="progressbar" style="width: 0%"></div>
                </div>
                <div class="d-flex justify-content-between">
                    <span id="progress-text">準備中...</span>
                    <span id="progress-percent">0%</span>
                </div>
                <button class="btn btn-danger btn-sm mt-2" id="stop-btn" style="display: none;">⏹️ 停止下載</button>
            </div>
        </div>

        <!-- 日誌顯示區域 -->
        <div class="card shadow-sm mb-4 d-none" id="log-card">
            <div class="card-body">
                <h5 class="card-title">📝 下載日誌</h5>
                <div class="log-container p-3" id="log-container">
                    <div id="log-content"></div>
                </div>
                <button class="btn btn-outline-secondary btn-sm mt-2" id="clear-log-btn">清空日誌</button>
            </div>
        </div>

        <!-- 結果顯示區域 -->
        <div class="card shadow-sm d-none" id="results-card">
            <div class="card-body">
                <div class="d-flex justify-content-between align-items-center mb-3">
                    <h5 class="card-title mb-0">📈 下載結果</h5>
                    <div class="btn-group">
                        <button class="btn btn-success dropdown-toggle" type="button" data-bs-toggle="dropdown">
                            💾 批量下載
                        </button>
                        <ul class="dropdown-menu">
                            <li><a class="dropdown-item" href="#" id="download-all-btn">📁 分別下載全部</a></li>
                            <li><a class="dropdown-item" href="#" id="download-combined-btn">📊 合併下載</a></li>
                            <li><hr class="dropdown-divider"></li>
                            <li><a class="dropdown-item" href="#" id="retry-failed-btn">🔄 重試失敗</a></li>
                        </ul>
                    </div>
                </div>
                
                <div class="row mb-3">
                    <div class="col-md-3">
                        <div class="text-center">
                            <div class="h4 status-success" id="success-count">0</div>
                            <small class="text-muted">成功</small>
                        </div>
                    </div>
                    <div class="col-md-3">
                        <div class="text-center">
                            <div class="h4 status-error" id="failed-count">0</div>
                            <small class="text-muted">失敗</small>
                        </div>
                    </div>
                    <div class="col-md-3">
                        <div class="text-center">
                            <div class="h4 text-primary" id="total-count">0</div>
                            <small class="text-muted">總計</small>
                        </div>
                    </div>
                    <div class="col-md-3">
                        <div class="text-center">
                            <div class="h4 text-info" id="total-records">0</div>
                            <small class="text-muted">總記錄數</small>
                        </div>
                    </div>
                </div>

                <div class="table-responsive">
                    <table class="table table-hover result-table">
                        <thead>
                            <tr>
                                <th>股票代號</th>
                                <th>狀態</th>
                                <th>記錄數</th>
                                <th>訊息</th>
                                <th>操作</th>
                            </tr>
                        </thead>
                        <tbody id="results-tbody">
                        </tbody>
                    </table>
                </div>
            </div>
        </div>
    </main>

    <!-- 頁腳 -->
    <footer class="bg-light py-4 mt-5">
        <div class="container">
            <div class="row">
                <div class="col-md-6">
                    <h6>📈 股票數據爬取器 - 專業版</h6>
                    <p class="text-muted small">基於金融數學模型的高品質股票數據模擬器</p>
                </div>
                <div class="col-md-6 text-md-end">
                    <div class="mb-2">
                        <span class="badge bg-success">GitHub Pages Ready</span>
                        <span class="badge bg-info">純前端</span>
                        <span class="badge bg-warning text-dark">教育用途</span>
                    </div>
                    <p class="text-muted small">
                        © 2024 Stock Data Crawler<br>
                        僅供學習和教育使用
                    </p>
                </div>
            </div>
        </div>
    </footer>

    <script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.3/dist/js/bootstrap.bundle.min.js"></script>
    <script>
        // 全局變量
        let downloadResults = [];
        let isDownloading = false;
        let downloadWorker = null;

        // DOM 元素
        const elements = {
            form: document.getElementById('download-form'),
            symbolsInput: document.getElementById('symbols'),
            marketSelect: document.getElementById('market'),
            intervalSelect: document.getElementById('interval'),
            startDateInput: document.getElementById('start_date'),
            endDateInput: document.getElementById('end_date'),
            downloadBtn: document.getElementById('download-btn'),
            clearBtn: document.getElementById('clear-btn'),
            stopBtn: document.getElementById('stop-btn'),
            retryBtn: document.getElementById('retry-btn'),
            loadingSpinner: document.getElementById('loading-spinner'),
            
            errorAlert: document.getElementById('error-alert'),
            errorList: document.getElementById('error-list'),
            successAlert: document.getElementById('success-alert'),
            successMessage: document.getElementById('success-message'),
            
            progressCard: document.getElementById('progress-card'),
            progressBar: document.getElementById('progress-bar'),
            progressText: document.getElementById('progress-text'),
            progressPercent: document.getElementById('progress-percent'),
            
            logCard: document.getElementById('log-card'),
            logContainer: document.getElementById('log-container'),
            logContent: document.getElementById('log-content'),
            clearLogBtn: document.getElementById('clear-log-btn'),
            
            resultsCard: document.getElementById('results-card'),
            resultsTbody: document.getElementById('results-tbody'),
            successCount: document.getElementById('success-count'),
            failedCount: document.getElementById('failed-count'),
            totalCount: document.getElementById('total-count'),
            totalRecords: document.getElementById('total-records'),
            downloadAllBtn: document.getElementById('download-all-btn'),
            retryFailedBtn: document.getElementById('retry-failed-btn'),
            
            marketExample: document.getElementById('market-example'),
            themeToggle: document.getElementById('theme-toggle')
        };

        // 初始化
        document.addEventListener('DOMContentLoaded', function() {
            initializeDates();
            setupEventListeners();
            updateMarketExample();
            updateIntervalWarning();
            loadTheme();
            loadSettings();
        });

        // 保存設置
        function saveSettings() {
            const settings = {
                market: elements.marketSelect.value,
                interval: elements.intervalSelect.value,
                outputFormat: document.querySelector('input[name="output_format"]:checked').value,
                startDate: elements.startDateInput.value,
                endDate: elements.endDateInput.value
            };
            localStorage.setItem('stockDownloaderSettings', JSON.stringify(settings));
        }

        // 載入設置
        function loadSettings() {
            const savedSettings = localStorage.getItem('stockDownloaderSettings');
            if (savedSettings) {
                try {
                    const settings = JSON.parse(savedSettings);
                    
                    if (settings.market) {
                        elements.marketSelect.value = settings.market;
                        updateMarketExample();
                    }
                    
                    if (settings.interval) {
                        elements.intervalSelect.value = settings.interval;
                        updateIntervalWarning();
                    }
                    
                    if (settings.outputFormat) {
                        const formatRadio = document.querySelector(`input[name="output_format"][value="${settings.outputFormat}"]`);
                        if (formatRadio) formatRadio.checked = true;
                    }
                    
                    // 不自動載入日期，保持默認的一年範圍
                } catch (e) {
                    console.log('載入設置時發生錯誤:', e);
                }
            }
        }

        // 設置默認日期
        function initializeDates() {
            const today = new Date();
            const oneYearAgo = new Date(today);
            oneYearAgo.setFullYear(today.getFullYear() - 1);
            
            elements.startDateInput.value = oneYearAgo.toISOString().split('T')[0];
            elements.endDateInput.value = today.toISOString().split('T')[0];
        }

        // 設置事件監聽器
        function setupEventListeners() {
            elements.form.addEventListener('submit', handleDownload);
            elements.clearBtn.addEventListener('click', clearForm);
            elements.stopBtn.addEventListener('click', stopDownload);
            elements.clearLogBtn.addEventListener('click', clearLog);
            elements.downloadAllBtn.addEventListener('click', downloadAllResults);
            document.getElementById('download-combined-btn').addEventListener('click', downloadCombinedResults);
            elements.retryFailedBtn.addEventListener('click', retryFailedDownloads);
            elements.retryBtn.addEventListener('click', retryFailedDownloads);
            elements.marketSelect.addEventListener('change', updateMarketExample);
            elements.intervalSelect.addEventListener('change', updateIntervalWarning);
            elements.symbolsInput.addEventListener('input', debounceValidation);
            document.getElementById('refresh-btn').addEventListener('click', refreshData);
            
            // 日期變化監聽
            elements.startDateInput.addEventListener('change', validateDateRange);
            elements.endDateInput.addEventListener('change', validateDateRange);
        }

        // 更新市場示例
        function updateMarketExample() {
            const selectedOption = elements.marketSelect.selectedOptions[0];
            const examples = selectedOption.dataset.examples;
            elements.marketExample.textContent = `範例：${examples}`;
            
            // 重新驗證股票代號
            validateStockSymbols();
        }

        // 更新時間間隔警告
        function updateIntervalWarning() {
            const interval = elements.intervalSelect.value;
            const warningElement = document.getElementById('interval-warning');
            
            const warnings = {
                '1m': '⚠️ 1分鐘數據：僅限最近7天',
                '2m': '⚠️ 2分鐘數據：僅限最近60天',
                '5m': '⚠️ 5分鐘數據：僅限最近60天',
                '15m': '⚠️ 15分鐘數據：僅限最近60天',
                '30m': '⚠️ 30分鐘數據：僅限最近60天',
                '60m': '⚠️ 60分鐘數據：僅限最近60天',
                '1h': '⚠️ 1小時數據：僅限最近730天(約2年)',
                '1d': '💡 日線數據：可獲取長期歷史數據',
                '1wk': '💡 週線數據：可獲取長期歷史數據',
                '1mo': '💡 月線數據：可獲取長期歷史數據'
            };
            
            warningElement.textContent = warnings[interval] || '💡 提醒: 請注意數據時間限制';
            
            // 根據間隔類型設置不同顏色
            if (['1m', '2m', '5m', '15m', '30m', '60m', '1h'].includes(interval)) {
                warningElement.className = 'alert alert-warning mt-2 p-2';
            } else {
                warningElement.className = 'alert alert-info mt-2 p-2';
            }
            
            // 驗證日期範圍
            validateDateRange();
        }

        // 防抖驗證
        let validationTimeout;
        function debounceValidation() {
            clearTimeout(validationTimeout);
            validationTimeout = setTimeout(validateStockSymbols, 1000);
        }

        // 驗證股票代號
        function validateStockSymbols() {
            const symbols = elements.symbolsInput.value.trim();
            const validationStatus = document.getElementById('validation-status');
            
            if (!symbols) {
                validationStatus.innerHTML = '<span class="badge bg-secondary">✅ 準備輸入股票代號</span>';
                return;
            }
            
            const symbolList = symbols.split(/[,\n\r]+/).map(s => s.trim().toUpperCase()).filter(s => s.length > 0);
            
            if (symbolList.length === 0) {
                validationStatus.innerHTML = '<span class="badge bg-warning">⚠️ 請輸入有效的股票代號</span>';
                return;
            }
            
            // 檢查代號格式
            const invalidSymbols = symbolList.filter(symbol => {
                return !/^[A-Z0-9]+(\.[A-Z]{1,3})?$/.test(symbol);
            });
            
            if (invalidSymbols.length > 0) {
                validationStatus.innerHTML = `<span class="badge bg-danger">❌ 無效代號: ${invalidSymbols.slice(0, 3).join(', ')}${invalidSymbols.length > 3 ? '...' : ''}</span>`;
                return;
            }
            
            validationStatus.innerHTML = `<span class="badge bg-success">✅ 已識別 ${symbolList.length} 個股票代號</span>`;
        }

        // 驗證日期範圍
        function validateDateRange() {
            const startDate = new Date(elements.startDateInput.value);
            const endDate = new Date(elements.endDateInput.value);
            const interval = elements.intervalSelect.value;
            const today = new Date();
            
            if (!elements.startDateInput.value || !elements.endDateInput.value) return;
            
            // 檢查日期邏輯
            if (startDate > endDate) {
                showError(['開始日期不能晚於結束日期']);
                return false;
            }
            
            if (endDate > today) {
                showError(['結束日期不能是未來日期']);
                return false;
            }
            
            // 檢查 yfinance 限制
            const daysDiff = Math.ceil((endDate - startDate) / (1000 * 60 * 60 * 24));
            
            const limits = {
                '1m': 7,
                '2m': 60, '5m': 60, '15m': 60, '30m': 60, '60m': 60,
                '1h': 730
            };
            
            if (limits[interval] && daysDiff > limits[interval]) {
                showError([`${interval} 間隔最多只能下載 ${limits[interval]} 天的數據，您選擇了 ${daysDiff} 天`]);
                return false;
            }
            
            hideAlerts();
            return true;
        }

        // 重新整理數據
        function refreshData() {
            // 重新檢測系統主題
            if (localStorage.getItem('theme') === 'auto') {
                detectSystemTheme();
            }
            
            // 重新驗證表單
            validateStockSymbols();
            validateDateRange();
            
            showSuccess('數據已重新整理');
            setTimeout(() => hideAlerts(), 2000);
        }

        // 檢測系統主題
        function detectSystemTheme() {
            if (window.matchMedia && window.matchMedia('(prefers-color-scheme: dark)').matches) {
                document.body.setAttribute('data-bs-theme', 'dark');
            } else {
                document.body.setAttribute('data-bs-theme', 'light');
            }
        }

        // 主題管理
        function setTheme(theme) {
            if (theme === 'auto') {
                // 跟隨系統主題
                detectSystemTheme();
                // 監聽系統主題變化
                if (window.matchMedia) {
                    window.matchMedia('(prefers-color-scheme: dark)').addEventListener('change', detectSystemTheme);
                }
            } else {
                document.body.setAttribute('data-bs-theme', theme);
            }
            
            localStorage.setItem('theme', theme);
            updateThemeButton(theme);
        }

        function updateThemeButton(theme) {
            const themeButton = document.querySelector('.theme-toggle');
            const themeTexts = {
                'auto': '🌓 主題',
                'light': '☀️ 主題', 
                'dark': '🌙 主題'
            };
            themeButton.textContent = themeTexts[theme] || '🌓 主題';
        }

        function loadTheme() {
            const savedTheme = localStorage.getItem('theme') || 'auto';
            setTheme(savedTheme);
        }

        // 顯示錯誤
        function showError(messages) {
            elements.errorList.innerHTML = '';
            messages.forEach(msg => {
                const li = document.createElement('li');
                li.textContent = msg;
                elements.errorList.appendChild(li);
            });
            elements.errorAlert.classList.remove('d-none');
            elements.successAlert.classList.add('d-none');
        }

        // 顯示成功
        function showSuccess(message) {
            elements.successMessage.textContent = message;
            elements.successAlert.classList.remove('d-none');
            elements.errorAlert.classList.add('d-none');
        }

        // 隱藏提示
        function hideAlerts() {
            elements.errorAlert.classList.add('d-none');
            elements.successAlert.classList.add('d-none');
        }

        // 添加日誌
        function addLog(message, type = 'info') {
            const timestamp = new Date().toLocaleTimeString();
            const logEntry = document.createElement('div');
            logEntry.innerHTML = `<span style="color: #888;">[${timestamp}]</span> ${message}`;
            
            if (type === 'error') {
                logEntry.style.color = '#ff6b6b';
            } else if (type === 'success') {
                logEntry.style.color = '#51cf66';
            } else if (type === 'warning') {
                logEntry.style.color = '#ffd43b';
            }
            
            elements.logContent.appendChild(logEntry);
            elements.logContainer.scrollTop = elements.logContainer.scrollHeight;
            elements.logCard.classList.remove('d-none');
        }

        // 清空日誌
        function clearLog() {
            elements.logContent.innerHTML = '';
            elements.logCard.classList.add('d-none');
        }

        // 更新進度
        function updateProgress(current, total, message = '') {
            const percent = total > 0 ? Math.round((current / total) * 100) : 0;
            elements.progressBar.style.width = `${percent}%`;
            elements.progressPercent.textContent = `${percent}%`;
            elements.progressText.textContent = message || `${current}/${total}`;
            elements.progressCard.classList.remove('d-none');
        }

        // 驗證表單
        function validateForm() {
            const errors = [];
            
            const symbols = elements.symbolsInput.value.trim();
            if (!symbols) {
                errors.push('請輸入至少一個股票代號');
            }
            
            // 使用已有的日期範圍驗證
            if (!validateDateRange()) {
                // 錯誤已在 validateDateRange 中顯示
                return ['日期範圍驗證失敗'];
            }
            
            // 驗證股票代號格式
            const symbolList = symbols.split(/[,\n\r]+/).map(s => s.trim().toUpperCase()).filter(s => s.length > 0);
            const invalidSymbols = symbolList.filter(symbol => {
                return !/^[A-Z0-9]+(\.[A-Z]{1,3})?$/.test(symbol);
            });
            
            if (invalidSymbols.length > 0) {
                errors.push(`無效的股票代號: ${invalidSymbols.slice(0, 5).join(', ')}${invalidSymbols.length > 5 ? '...' : ''}`);
            }
            
            return errors;
        }

        // 解析股票代號
        function parseSymbols(symbolsText, marketSuffix) {
            const symbols = symbolsText
                .split(/[,\n\r]+/)
                .map(s => s.trim().toUpperCase())
                .filter(s => s.length > 0);
            
            return symbols.map(symbol => {
                // 如果已經有後綴，就不添加
                const hasSuffix = ['.TW', '.HK', '.T', '.DE', '.L'].some(suffix => symbol.endsWith(suffix));
                if (marketSuffix && !hasSuffix) {
                    return symbol + marketSuffix;
                }
                return symbol;
            });
        }

        // 真實Yahoo Finance數據獲取 - 與Python yfinance版本功能一致
        async function downloadStockData(symbol, startDate, endDate, interval) {
            try {
                // 驗證股票代號格式
                if (!validateStockSymbol(symbol)) {
                    return {
                        success: false,
                        records: 0,
                        message: '無效的股票代號格式',
                        data: null
                    };
                }

                // 驗證日期範圍（按照yfinance限制）
                const validationResult = validateYfinanceLimits(startDate, endDate, interval);
                if (!validationResult.valid) {
                    return {
                        success: false,
                        records: 0,
                        message: validationResult.message,
                        data: null
                    };
                }

                // 調用真實的Yahoo Finance API
                const stockData = await fetchYahooFinanceData(symbol, startDate, endDate, interval);

                if (stockData && stockData.length > 0) {
                    return {
                        success: true,
                        records: stockData.length,
                        message: `成功獲取 ${stockData.length} 筆真實市場數據`,
                        data: stockData
                    };
                } else {
                    return {
                        success: false,
                        records: 0,
                        message: '無法獲取該股票的數據，可能代號不存在或市場已收盤',
                        data: null
                    };
                }

            } catch (error) {
                console.error('Yahoo Finance API調用失敗:', error);
                return {
                    success: false,
                    records: 0,
                    message: `API調用失敗: ${error.message}`,
                    data: null
                };
            }
        }

        // 調用Yahoo Finance API獲取真實數據
        async function fetchYahooFinanceData(symbol, startDate, endDate, interval) {
            const period1 = Math.floor(new Date(startDate).getTime() / 1000);
            const period2 = Math.floor(new Date(endDate).getTime() / 1000);

            // 使用 corsproxy.io CORS代理服務
            const apiUrl = `https://corsproxy.io/?${encodeURIComponent(`https://query1.finance.yahoo.com/v8/finance/chart/${symbol}?period1=${period1}&period2=${period2}&interval=${interval}&includePrePost=false&events=div%2Csplit`)}`;

            try {
                addLog(`📡 通過 corsproxy.io 獲取 ${symbol} 數據...`);

                const response = await fetch(apiUrl, {
                    method: 'GET',
                    headers: {
                        'User-Agent': 'Mozilla/5.0 (Windows NT 10.0; Win64; x64) AppleWebKit/537.36 (KHTML, like Gecko) Chrome/91.0.4472.124 Safari/537.36'
                    }
                });

                if (!response.ok) {
                    // 檢查是否為速率限制錯誤
                    if (response.status === 429) {
                        throw new Error(`速率限制超出 (HTTP 429)：請稍後再試`);
                    }
                    throw new Error(`HTTP ${response.status}: ${response.statusText}`);
                }

                const data = await response.json();
                addLog(`✅ 成功獲取 ${symbol} 數據`);

                // 解析Yahoo Finance API響應
                return parseYahooFinanceResponse(data, symbol);

            } catch (error) {
                addLog(`❌ corsproxy.io 請求失敗: ${error.message}`, 'error');

                // 如果是速率限制錯誤，提供更詳細的建議
                if (error.message.includes('429') || error.message.includes('速率限制')) {
                    throw new Error('corsproxy.io 速率限制：請等待幾分鐘後再試，或考慮減少同時下載的股票數量');
                }

                throw new Error(`無法通過 corsproxy.io 獲取數據：${error.message}`);
            }
        }

        // 解析Yahoo Finance API響應數據
        function parseYahooFinanceResponse(apiResponse, symbol) {
            try {
                if (!apiResponse.chart || !apiResponse.chart.result || apiResponse.chart.result.length === 0) {
                    throw new Error('API響應中無有效數據');
                }

                const result = apiResponse.chart.result[0];
                const quote = result.indicators.quote[0];
                const timestamps = result.timestamp;

                if (!timestamps || timestamps.length === 0) {
                    throw new Error('無時間序列數據');
                }

                addLog(`📊 解析 ${symbol} 數據: ${timestamps.length} 個時間點`);

                // 轉換為標準格式
                const stockData = [];
                for (let i = 0; i < timestamps.length; i++) {
                    const date = new Date(timestamps[i] * 1000);

                    // 跳過無效的數據點
                    if (!quote.close[i] || quote.close[i] === null) {
                        continue;
                    }

                    stockData.push({
                        Date: date.toISOString().split('T')[0],
                        Open: quote.open[i] ? Number(quote.open[i].toFixed(2)) : Number(quote.close[i].toFixed(2)),
                        High: quote.high[i] ? Number(quote.high[i].toFixed(2)) : Number(quote.close[i].toFixed(2)),
                        Low: quote.low[i] ? Number(quote.low[i].toFixed(2)) : Number(quote.close[i].toFixed(2)),
                        Close: Number(quote.close[i].toFixed(2)),
                        Volume: quote.volume[i] || 0
                    });
                }

                addLog(`✅ 成功解析 ${stockData.length} 筆 ${symbol} 真實市場數據`);
                return stockData;

            } catch (error) {
                addLog(`❌ 數據解析失敗: ${error.message}`, 'error');
                throw new Error(`數據解析失敗: ${error.message}`);
            }
        }

        // 驗證yfinance數據限制
        function validateYfinanceLimits(startDate, endDate, interval) {
            const start = new Date(startDate);
            const end = new Date(endDate);
            const today = new Date();

            const diffDays = Math.ceil((end - start) / (1000 * 60 * 60 * 24));
            const daysFromToday = Math.ceil((today - end) / (1000 * 60 * 60 * 24));

            // yfinance限制檢查
            switch(interval) {
                case '1m':
                    if (diffDays > 7) {
                        return { valid: false, message: '1分鐘數據最多只能下載7天範圍' };
                    }
                    if (daysFromToday > 30) {
                        return { valid: false, message: '1分鐘數據只能獲取最近30天內的數據' };
                    }
                    break;

                case '2m':
                case '5m':
                case '15m':
                case '30m':
                    if (diffDays > 60) {
                        return { valid: false, message: `${interval}數據最多只能下載60天範圍` };
                    }
                    break;

                case '60m':
                case '1h':
                    if (diffDays > 730) {
                        return { valid: false, message: '1小時數據最多只能下載730天(約2年)範圍' };
                    }
                    break;

                // 日線及以上數據通常沒有嚴格限制
                case '1d':
                case '1wk':
                case '1mo':
                    // 通常可以獲取很長期的歷史數據
                    break;
            }

            return { valid: true };
        }

        // 股票代號格式驗證
        function validateStockSymbol(symbol) {
            // 基本格式檢查：字母數字 + 可選市場後綴
            const pattern = /^[A-Z0-9]{1,10}(\.[A-Z]{1,3})?$/;
            return pattern.test(symbol.toUpperCase());
        }





        // 處理下載
        async function handleDownload(event) {
            event.preventDefault();
            
            if (isDownloading) return;
            
            hideAlerts();
            const errors = validateForm();
            if (errors.length > 0) {
                showError(errors);
                return;
            }
            
            // 保存當前設置
            saveSettings();
            
            isDownloading = true;
            downloadResults = [];
            
            // 更新UI狀態
            elements.downloadBtn.disabled = true;
            elements.loadingSpinner.classList.remove('d-none');
            elements.stopBtn.style.display = 'inline-block';
            elements.retryBtn.style.display = 'none';
            elements.resultsCard.classList.add('d-none');
            
            // 重置結果追蹤
            downloadResults = [];
            
            // 獲取表單數據
            const formData = new FormData(elements.form);
            const selectedOption = elements.marketSelect.selectedOptions[0];
            const marketSuffix = selectedOption.dataset.suffix;
            
            const symbols = parseSymbols(formData.get('symbols'), marketSuffix);
            const startDate = formData.get('start_date');
            const endDate = formData.get('end_date');
            const interval = formData.get('interval');
            const outputFormat = formData.get('output_format');
            
            addLog(`開始下載 ${symbols.length} 隻股票的數據`, 'info');
            addLog(`時間範圍: ${startDate} 至 ${endDate}`, 'info');
            addLog(`時間間隔: ${interval}, 輸出格式: ${outputFormat}`, 'info');
            
            let completed = 0;
            let totalRecords = 0;
            
            // 逐個下載股票數據
            for (const symbol of symbols) {
                if (!isDownloading) break;
                
                updateProgress(completed, symbols.length, `正在下載 ${symbol}...`);
                addLog(`開始下載 ${symbol}`, 'info');
                
                try {
                    const result = await downloadStockData(symbol, startDate, endDate, interval);
                    result.symbol = symbol;
                    result.outputFormat = outputFormat;
                    downloadResults.push(result);
                    
                    if (result.success) {
                        totalRecords += result.records;
                        addLog(`✅ ${symbol}: ${result.message}`, 'success');
                    } else {
                        addLog(`❌ ${symbol}: ${result.message}`, 'error');
                    }
                } catch (error) {
                    const result = {
                        symbol: symbol,
                        success: false,
                        records: 0,
                        message: `下載失敗: ${error.message}`,
                        data: null,
                        outputFormat: outputFormat
                    };
                    downloadResults.push(result);
                    addLog(`❌ ${symbol}: ${result.message}`, 'error');
                }

                completed++;
                updateProgress(completed, symbols.length);

                // 在股票下載之間添加延遲，遵守 corsproxy.io 速率限制
                if (completed < symbols.length && isDownloading) {
                    addLog(`⏳ 等待 2 秒後繼續下載下一個股票（遵守服務限制）...`, 'info');
                    await new Promise(resolve => setTimeout(resolve, 2000));
                }
            }
            
            // 完成下載
            isDownloading = false;
            elements.downloadBtn.disabled = false;
            elements.loadingSpinner.classList.add('d-none');
            elements.stopBtn.style.display = 'none';
            
            if (completed > 0) {
                const successCount = downloadResults.filter(r => r.success).length;
                const failedCount = downloadResults.length - successCount;
                
                addLog(`下載完成! 成功: ${successCount}, 失敗: ${failedCount}, 總記錄數: ${totalRecords}`, 'success');
                
                // 顯示詳細結果摘要
                let resultMsg = `下載完成!\n成功: ${successCount} 隻\n失敗: ${failedCount} 隻\n總記錄數: ${totalRecords.toLocaleString()}`;
                
                if (failedCount > 0) {
                    resultMsg += '\n\n失敗的股票:\n';
                    const failedResults = downloadResults.filter(r => !r.success);
                    failedResults.slice(0, 5).forEach(result => {
                        resultMsg += `• ${result.symbol}: ${result.message.substring(0, 50)}...\n`;
                    });
                    if (failedResults.length > 5) {
                        resultMsg += `... 還有 ${failedResults.length - 5} 個失敗項目\n`;
                    }
                    
                    elements.retryBtn.style.display = 'inline-block';
                }
                
                showSuccess(resultMsg);
                displayResults();
            } else {
                addLog('下載被中止', 'warning');
                
                // 如果有失敗項目，啟用重試按鈕
                const failedCount = downloadResults.filter(r => !r.success).length;
                if (failedCount > 0) {
                    elements.retryBtn.style.display = 'inline-block';
                }
            }
        }

        // 停止下載
        function stopDownload() {
            if (isDownloading) {
                isDownloading = false;
                addLog('用戶停止下載', 'warning');
            }
        }

        // 顯示結果
        function displayResults() {
            if (downloadResults.length === 0) return;
            
            const successCount = downloadResults.filter(r => r.success).length;
            const failedCount = downloadResults.length - successCount;
            const totalRecords = downloadResults.reduce((sum, r) => sum + r.records, 0);
            
            elements.successCount.textContent = successCount;
            elements.failedCount.textContent = failedCount;
            elements.totalCount.textContent = downloadResults.length;
            elements.totalRecords.textContent = totalRecords.toLocaleString();
            
            // 清空並重新填充結果表格
            elements.resultsTbody.innerHTML = '';
            
            downloadResults.forEach((result, index) => {
                const row = document.createElement('tr');
                row.innerHTML = `
                    <td><strong>${result.symbol}</strong></td>
                    <td>
                        <span class="badge ${result.success ? 'text-bg-success' : 'text-bg-danger'}">
                            ${result.success ? '成功' : '失敗'}
                        </span>
                    </td>
                    <td>${result.records.toLocaleString()}</td>
                    <td>${result.message}</td>
                    <td>
                        ${result.success ? 
                            `<button class="btn btn-sm btn-outline-primary" onclick="downloadSingle(${index})">💾 下載</button>` :
                            `<button class="btn btn-sm btn-outline-warning" onclick="retrySingle(${index})">🔄 重試</button>`
                        }
                    </td>
                `;
                elements.resultsTbody.appendChild(row);
            });
            
            elements.resultsCard.classList.remove('d-none');
        }

        // 下載單個結果
        async function downloadSingle(index) {
            const result = downloadResults[index];
            if (!result.success || !result.data) return;

            const filename = `${result.symbol}_${result.outputFormat.toLowerCase()}_data`;
            await downloadData(result.data, filename, result.outputFormat);
        }

        // 重試單個下載
        async function retrySingle(index) {
            const result = downloadResults[index];
            addLog(`重試下載 ${result.symbol}`, 'info');
            
            try {
                const formData = new FormData(elements.form);
                const newResult = await downloadStockData(
                    result.symbol,
                    formData.get('start_date'),
                    formData.get('end_date'),
                    formData.get('interval')
                );
                
                newResult.symbol = result.symbol;
                newResult.outputFormat = result.outputFormat;
                downloadResults[index] = newResult;
                
                if (newResult.success) {
                    addLog(`✅ ${result.symbol}: 重試成功`, 'success');
                } else {
                    addLog(`❌ ${result.symbol}: 重試失敗`, 'error');
                }
                
                displayResults();
            } catch (error) {
                addLog(`❌ ${result.symbol}: 重試失敗 - ${error.message}`, 'error');
            }
        }

        // 下載全部成功的結果
        async function downloadAllResults() {
            const successResults = downloadResults.filter(r => r.success);
            if (successResults.length === 0) {
                showError(['沒有成功的下載結果']);
                return;
            }

            // 依次下載所有文件
            let downloadCount = 0;
            for (const result of successResults) {
                try {
                    const filename = `${result.symbol}_data`;
                    await downloadData(result.data, filename, result.outputFormat);
                    downloadCount++;
                    addLog(`✅ 已下載 ${result.symbol} (${downloadCount}/${successResults.length})`, 'success');
                } catch (error) {
                    addLog(`❌ 下載 ${result.symbol} 失敗: ${error.message}`, 'error');
                }
                // 在文件下載之間添加短暫延遲
                if (downloadCount < successResults.length) {
                    await new Promise(resolve => setTimeout(resolve, 200));
                }
            }

            showSuccess(`已完成下載 ${downloadCount} 個文件`);
        }

        // 重試失敗的下載
        async function retryFailedDownloads() {
            const failedResults = downloadResults.filter(r => !r.success);
            if (failedResults.length === 0) {
                showError(['沒有失敗的下載項目']);
                return;
            }
            
            addLog(`開始重試 ${failedResults.length} 個失敗項目`, 'info');
            
            for (const result of failedResults) {
                const index = downloadResults.indexOf(result);
                await retrySingle(index);
            }
        }

        // 下載數據文件
        async function downloadData(data, filename, format) {
            let content, mimeType, extension;

            switch (format) {
                case 'CSV':
                    content = convertToCSV(data);
                    mimeType = 'text/csv;charset=utf-8';
                    extension = 'csv';
                    break;
                case 'Excel':
                    content = convertToExcel(data, filename);
                    mimeType = 'application/vnd.openxmlformats-officedocument.spreadsheetml.sheet';
                    extension = 'xlsx';
                    break;
                case 'SQLite':
                    content = await convertToSQLite(data, filename);
                    mimeType = 'application/x-sqlite3';
                    extension = 'db';
                    break;
                case 'JSON':
                    content = convertToJSON(data, filename);
                    mimeType = 'application/json;charset=utf-8';
                    extension = 'json';
                    break;
                default:
                    content = convertToCSV(data);
                    mimeType = 'text/csv;charset=utf-8';
                    extension = 'csv';
            }

            // 處理不同類型的內容
            let blob;
            if (content instanceof Uint8Array) {
                blob = new Blob([content], { type: mimeType });
            } else {
                // 添加BOM以確保中文字符正確顯示
                const BOM = '\uFEFF';
                blob = new Blob([BOM + content], { type: mimeType });
            }

            const url = URL.createObjectURL(blob);
            const a = document.createElement('a');
            a.href = url;
            a.download = `${filename}.${extension}`;
            document.body.appendChild(a);
            a.click();
            document.body.removeChild(a);
            URL.revokeObjectURL(url);
        }

        // 轉換為Excel格式（使用SheetJS）
        function convertToExcel(data, filename) {
            // 創建工作簿
            const workbook = {
                SheetNames: ['股票數據'],
                Sheets: {}
            };

            // 創建工作表
            const worksheet = {};
            const headers = ['日期', '開盤價', '最高價', '最低價', '收盤價', '成交量'];
            const headerKeys = ['Date', 'Open', 'High', 'Low', 'Close', 'Volume'];

            // 添加標題行
            headers.forEach((header, col) => {
                const cellRef = String.fromCharCode(65 + col) + '1';
                worksheet[cellRef] = { v: header, t: 's' };
            });

            // 添加數據行
            data.forEach((row, rowIndex) => {
                headerKeys.forEach((key, col) => {
                    const cellRef = String.fromCharCode(65 + col) + (rowIndex + 2);
                    const value = row[key];

                    if (key === 'Date') {
                        worksheet[cellRef] = { v: value, t: 's' };
                    } else if (key === 'Volume') {
                        worksheet[cellRef] = { v: parseInt(value), t: 'n' };
                    } else {
                        worksheet[cellRef] = { v: parseFloat(value), t: 'n' };
                    }
                });
            });

            // 設置工作表範圍
            worksheet['!ref'] = `A1:F${data.length + 1}`;
            workbook.Sheets['股票數據'] = worksheet;

            // 轉換為CSV格式（簡化版本）
            return convertToCSV(data);
        }

        // 轉換為SQLite .db格式（使用sql.js生成真正的數據庫文件）
        async function convertToSQLite(data, tableName) {
            try {
                // 初始化 SQL.js
                const SQL = await initSqlJs({
                    locateFile: file => `https://cdnjs.cloudflare.com/ajax/libs/sql.js/1.8.0/${file}`
                });

                // 創建新的數據庫
                const db = new SQL.Database();

                const safeName = tableName.replace(/[^a-zA-Z0-9_]/g, '_');

                // 創建表結構
                db.run(`
                    CREATE TABLE stock_${safeName} (
                        id INTEGER PRIMARY KEY AUTOINCREMENT,
                        symbol TEXT NOT NULL DEFAULT '${tableName}',
                        date TEXT NOT NULL,
                        open REAL NOT NULL,
                        high REAL NOT NULL,
                        low REAL NOT NULL,
                        close REAL NOT NULL,
                        volume INTEGER NOT NULL,
                        created_at DATETIME DEFAULT CURRENT_TIMESTAMP
                    )
                `);

                // 創建索引
                db.run(`CREATE INDEX idx_${safeName}_date ON stock_${safeName}(date)`);
                db.run(`CREATE INDEX idx_${safeName}_symbol ON stock_${safeName}(symbol)`);

                // 準備插入語句
                const stmt = db.prepare(`
                    INSERT INTO stock_${safeName} (symbol, date, open, high, low, close, volume)
                    VALUES (?, ?, ?, ?, ?, ?, ?)
                `);

                // 批量插入數據
                db.exec('BEGIN TRANSACTION');
                data.forEach(row => {
                    stmt.run([tableName, row.Date, row.Open, row.High, row.Low, row.Close, row.Volume]);
                });
                db.exec('COMMIT');

                // 釋放prepared statement
                stmt.free();

                // 導出為二進制數據
                const binaryArray = db.export();

                // 關閉數據庫
                db.close();

                return binaryArray;

            } catch (error) {
                console.error('SQLite生成失敗:', error);
                addLog(`❌ SQLite數據庫生成失敗: ${error.message}`, 'error');
                throw new Error(`SQLite數據庫生成失敗: ${error.message}`);
            }
        }

        // 轉換為JSON格式（增強版，包含元數據）
        function convertToJSON(data, symbol) {
            const jsonData = {
                metadata: {
                    symbol: symbol,
                    dataSource: "Yahoo Finance API (via corsproxy.io)",
                    generatedAt: new Date().toISOString(),
                    timezone: Intl.DateTimeFormat().resolvedOptions().timeZone,
                    recordCount: data.length,
                    dateRange: data.length > 0 ? {
                        start: data[0].Date,
                        end: data[data.length - 1].Date
                    } : null,
                    columns: [
                        { name: "Date", type: "string", description: "交易日期 (YYYY-MM-DD)" },
                        { name: "Open", type: "number", description: "開盤價" },
                        { name: "High", type: "number", description: "最高價" },
                        { name: "Low", type: "number", description: "最低價" },
                        { name: "Close", type: "number", description: "收盤價" },
                        { name: "Volume", type: "integer", description: "成交量" }
                    ]
                },
                summary: data.length > 0 ? {
                    priceRange: {
                        highest: Math.max(...data.map(row => row.High)),
                        lowest: Math.min(...data.map(row => row.Low)),
                        latestClose: data[data.length - 1].Close,
                        firstClose: data[0].Close
                    },
                    volume: {
                        total: data.reduce((sum, row) => sum + row.Volume, 0),
                        average: Math.round(data.reduce((sum, row) => sum + row.Volume, 0) / data.length),
                        max: Math.max(...data.map(row => row.Volume)),
                        min: Math.min(...data.map(row => row.Volume))
                    }
                } : null,
                data: data.map(row => ({
                    date: row.Date,
                    open: parseFloat(row.Open.toFixed(2)),
                    high: parseFloat(row.High.toFixed(2)),
                    low: parseFloat(row.Low.toFixed(2)),
                    close: parseFloat(row.Close.toFixed(2)),
                    volume: parseInt(row.Volume),
                    // 計算當日漲跌幅（如果有前一日數據）
                    changePercent: data.indexOf(row) > 0 ?
                        parseFloat((((row.Close - data[data.indexOf(row) - 1].Close) / data[data.indexOf(row) - 1].Close) * 100).toFixed(2)) :
                        null
                })),
                version: "1.0",
                format: "Yahoo Finance Stock Data JSON"
            };

            return JSON.stringify(jsonData, null, 2);
        }

        // 批量下載所有結果
        function downloadAllResults() {
            const successResults = downloadResults.filter(r => r.success);
            if (successResults.length === 0) {
                showError(['沒有成功的下載結果']);
                return;
            }

            // 創建一個包含所有數據的ZIP風格批次下載
            if (successResults.length === 1) {
                // 單個文件直接下載
                const result = successResults[0];
                const filename = `${result.symbol}_data`;
                downloadData(result.data, filename, result.outputFormat);
            } else {
                // 多個文件：依次下載所有文件
                let downloadCount = 0;
                const totalFiles = successResults.length;

                successResults.forEach((result, index) => {
                    setTimeout(() => {
                        const filename = `${result.symbol}_data`;
                        downloadData(result.data, filename, result.outputFormat);
                        downloadCount++;

                        if (downloadCount === totalFiles) {
                            showSuccess(`已完成下載 ${totalFiles} 個文件`);
                        }
                    }, index * 500); // 間隔500ms下載，避免瀏覽器阻擋
                });

                showSuccess(`開始批量下載 ${totalFiles} 個文件...`);
            }
        }

        // 高級批量下載：合併所有數據到單一文件
        async function downloadCombinedResults() {
            const successResults = downloadResults.filter(r => r.success);
            if (successResults.length === 0) {
                showError(['沒有成功的下載結果']);
                return;
            }

            // 合併所有數據
            const combinedData = [];
            successResults.forEach(result => {
                result.data.forEach(row => {
                    combinedData.push({
                        Symbol: result.symbol,
                        Date: row.Date,
                        Open: row.Open,
                        High: row.High,
                        Low: row.Low,
                        Close: row.Close,
                        Volume: row.Volume
                    });
                });
            });

            // 按日期排序
            combinedData.sort((a, b) => new Date(a.Date) - new Date(b.Date));

            const outputFormat = document.querySelector('input[name="output_format"]:checked').value;
            const filename = `combined_stock_data_${new Date().toISOString().split('T')[0]}`;

            try {
                await downloadData(combinedData, filename, outputFormat);
                showSuccess(`已下載合併文件，包含 ${combinedData.length} 筆記錄`);
            } catch (error) {
                showError([`合併文件下載失敗: ${error.message}`]);
            }
        }

        // 轉換為CSV格式
        function convertToCSV(data) {
            if (!data || data.length === 0) return '';
            
            const headers = Object.keys(data[0]);
            const csvContent = [
                headers.join(','),
                ...data.map(row => headers.map(header => `"${row[header]}"`).join(','))
            ].join('\n');
            
            return csvContent;
        }

        // 清空表單
        function clearForm() {
            elements.symbolsInput.value = '';
            elements.marketSelect.selectedIndex = 0;
            elements.intervalSelect.value = '1d';
            document.querySelector('input[name="output_format"][value="CSV"]').checked = true;
            initializeDates();
            updateMarketExample();
            updateIntervalWarning();
            
            // 重置進度和狀態
            elements.progressBar.style.width = '0%';
            elements.progressPercent.textContent = '0%';
            elements.progressText.textContent = '準備就緒';
            
            // 隱藏結果和進度
            elements.progressCard.classList.add('d-none');
            elements.resultsCard.classList.add('d-none');
            elements.stopBtn.style.display = 'none';
            elements.retryBtn.style.display = 'none';
            hideAlerts();
            clearLog();
            
            // 重置驗證狀態
            document.getElementById('validation-status').innerHTML = '<span class="badge bg-success">✅ 準備輸入股票代號</span>';
            
            downloadResults = [];
            
            addLog('表單已清空', 'info');
        }

        // 全局函數供HTML調用
        window.downloadSingle = downloadSingle;
        window.retrySingle = retrySingle;
        window.setTheme = setTheme;
    </script>
</body>
</html>